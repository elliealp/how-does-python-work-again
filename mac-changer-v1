#main function does not work properly if the new MAC input is in incorrect format ie xx:xx is automatically filled with 0
#code thinks xx:xx and xx:xx:00:00:00:00 are different and throws "your MAC was unchaged" despite the MAC changing properly

#!/usr/bin/env python

import subprocess
import optparse
import re


def get_args():
    parse = optparse.OptionParser()
    parse.add_option("-i", "--interface", dest="interface", help="Interface to change MAC")
    parse.add_option("-m", "--mac", dest="new_mac", help="New MAC address")
    (options, arguments) = parse.parse_args()

    if not options.interface:
        parse.error(" network interface not specified. (--help for more info.)")
    elif not options.new_mac:
        parse.error(" no MAC address entered. (--help for more info.)")
    return options


def change_mac(interface, new_mac):
    print("Changing the MAC for " + interface + " to " + new_mac)
    subprocess.call(["sudo", "ifconfig", interface, "down"])
    subprocess.call(["sudo", "ifconfig", interface, "hw", "ether", new_mac])
    subprocess.call(["sudo", "ifconfig", interface, "up"])


def get_current(interface):
    icf_result = subprocess.check_output(["ifconfig", interface])
    current_mac_search = re.search(r"\w\w:\w\w:\w\w:\w\w:\w\w:\w\w", icf_result)

    if current_mac_search:
        return current_mac_search.group(0)
    else:
        print("Couldn't find a MAC address.")


# main function
options = get_args()

current_mac = get_current(options.interface)

print("Current MAC is " + str(current_mac))

change_mac(options.interface, options.new_mac)

current_mac = get_current(options.interface)
if current_mac == options.new_mac:
    print("MAC was successfully changed to " + current_mac)
else:
    print("Your MAC was unchanged.")

